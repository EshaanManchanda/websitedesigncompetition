# Nginx Configuration for Kidrove Multi-Region Support
# Domains: kidrove.com, kidrove.in, kidrove.ae
# Backend Port: 5000 (localhost)
# Frontend: Static build served from /var/www/GEMA-Project/frontend/dist
# API Subdomains: api.kidrove.com, api.kidrove.in, api.kidrove.ae
#
# Server Blocks: 12 total (4 per domain)
# - HTTP Frontend (redirect to HTTPS)
# - HTTPS Frontend (serves React SPA)
# - HTTP API (redirect to HTTPS)
# - HTTPS API (proxies to Node.js backend)

# =====================================================================
# UPSTREAM BACKEND CONFIGURATION
# =====================================================================

upstream backend_api {
    server 127.0.0.1:5000 max_fails=3 fail_timeout=30s;
    keepalive 16;
    keepalive_timeout 60s;
    keepalive_requests 100;
}

# =====================================================================
# RATE LIMITING ZONES
# =====================================================================

# General API rate limiting (10 requests/second per IP)
limit_req_zone $binary_remote_addr zone=kidrove_api_limit:10m rate=10r/s;

# General traffic rate limiting (30 requests/second per IP)
limit_req_zone $binary_remote_addr zone=kidrove_general_limit:10m rate=30r/s;

# Connection limiting (max 10 concurrent connections per IP)
limit_conn_zone $binary_remote_addr zone=kidrove_conn_limit:10m;

# =====================================================================
# KIDROVE.COM - FRONTEND
# =====================================================================

# HTTP → HTTPS redirect for kidrove.com and www.kidrove.com
server {
    listen 80;
    listen [::]:80;
    server_name kidrove.com www.kidrove.com;

    # Allow Let's Encrypt validation
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS Frontend for kidrove.com and www.kidrove.com
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name kidrove.com www.kidrove.com;

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/kidrove.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/kidrove.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/kidrove.com/chain.pem;

    # SSL configuration
    include snippets/ssl-params.conf;

    # Security headers
    include snippets/security-headers.conf;

    # Connection limiting
    limit_conn kidrove_conn_limit 10;

    # Document root
    root /var/www/GEMA-Project/frontend/dist;
    index index.html;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    gzip_disable "msie6";

    # Client upload limits
    client_max_body_size 50M;
    client_body_timeout 120s;
    client_header_timeout 120s;

    # Static assets (long-term cache)
    location /assets/ {
        limit_req zone=kidrove_general_limit burst=50 nodelay;
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Access-Control-Allow-Origin "*";
        access_log off;
    }

    # Images (30-day cache)
    location /images/ {
        limit_req zone=kidrove_general_limit burst=50 nodelay;
        expires 30d;
        add_header Cache-Control "public";
        access_log off;
    }

    # Static files (1-year cache)
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # Service Worker (no cache)
    location = /sw.js {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        proxy_cache_bypass 1;
        proxy_no_cache 1;
    }

    # Favicon
    location = /favicon.ico {
        expires 7d;
        access_log off;
        log_not_found off;
    }

    # Robots.txt
    location = /robots.txt {
        expires 7d;
        access_log off;
        log_not_found off;
    }

    # React Router SPA fallback (must be last)
    location / {
        limit_req zone=kidrove_general_limit burst=50 nodelay;
        try_files $uri $uri/ /index.html;

        # HTML files - no cache
        location ~* \.html$ {
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
        }
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Deny access to sensitive files
    location ~ ^/(\.env|\.git|node_modules|package\.json|package-lock\.json) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Logging
    access_log /var/log/nginx/kidrove-com-access.log;
    error_log /var/log/nginx/kidrove-com-error.log warn;
}

# =====================================================================
# KIDROVE.COM - API
# =====================================================================

# HTTP → HTTPS redirect for api.kidrove.com
server {
    listen 80;
    listen [::]:80;
    server_name api.kidrove.com;

    # Allow Let's Encrypt validation
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # Redirect all other traffic to HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# HTTPS API for api.kidrove.com
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.kidrove.com;

    # SSL certificates
    ssl_certificate /etc/letsencrypt/live/api.kidrove.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.kidrove.com/privkey.pem;
    ssl_trusted_certificate /etc/letsencrypt/live/api.kidrove.com/chain.pem;

    # SSL configuration
    include snippets/ssl-params.conf;

    # Security headers
    include snippets/security-headers.conf;

    # Connection limiting
    limit_conn kidrove_conn_limit 10;

    # Client upload limits
    client_max_body_size 50M;
    client_body_timeout 120s;
    client_header_timeout 120s;

    # Health check endpoint (no rate limiting)
    location ~ ^/(api/)?health {
        include snippets/api-proxy.conf;
        access_log off;
    }

    # All API routes (with rate limiting)
    location / {
        limit_req zone=kidrove_api_limit burst=20 nodelay;
        include snippets/api-proxy.conf;
    }

    # Deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Logging
    access_log /var/log/nginx/api-kidrove-com-access.log;
    error_log /var/log/nginx/api-kidrove-com-error.log warn;
}

# =====================================================================
# KIDROVE.IN - FRONTEND
# =====================================================================

# HTTP → HTTPS redirect for kidrove.in and www.kidrove.in
# server {
#     listen 80;
#     listen [::]:80;
#     server_name kidrove.in www.kidrove.in;

#     # Allow Let's Encrypt validation
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }

#     # Redirect all other traffic to HTTPS
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }

# HTTPS Frontend for kidrove.in and www.kidrove.in
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name kidrove.in www.kidrove.in;

#     # SSL certificates
#     ssl_certificate /etc/letsencrypt/live/kidrove.in/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/kidrove.in/privkey.pem;
#     ssl_trusted_certificate /etc/letsencrypt/live/kidrove.in/chain.pem;

#     # SSL configuration
#     include snippets/ssl-params.conf;

#     # Security headers
#     include snippets/security-headers.conf;

#     # Connection limiting
#     limit_conn kidrove_conn_limit 10;

#     # Document root (same as .com)
#     root /var/www/GEMA-Project/frontend/dist;
#     index index.html;

#     # Gzip compression
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1024;
#     gzip_comp_level 6;
#     gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
#     gzip_disable "msie6";

#     # Client upload limits
#     client_max_body_size 50M;
#     client_body_timeout 120s;
#     client_header_timeout 120s;

#     # Static assets (long-term cache)
#     location /assets/ {
#         limit_req zone=kidrove_general_limit burst=50 nodelay;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         add_header Access-Control-Allow-Origin "*";
#         access_log off;
#     }

#     # Images (30-day cache)
#     location /images/ {
#         limit_req zone=kidrove_general_limit burst=50 nodelay;
#         expires 30d;
#         add_header Cache-Control "public";
#         access_log off;
#     }

#     # Static files (1-year cache)
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }

#     # Service Worker (no cache)
#     location = /sw.js {
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#         proxy_cache_bypass 1;
#         proxy_no_cache 1;
#     }

#     # Favicon
#     location = /favicon.ico {
#         expires 7d;
#         access_log off;
#         log_not_found off;
#     }

#     # Robots.txt
#     location = /robots.txt {
#         expires 7d;
#         access_log off;
#         log_not_found off;
#     }

#     # React Router SPA fallback (must be last)
#     location / {
#         limit_req zone=kidrove_general_limit burst=50 nodelay;
#         try_files $uri $uri/ /index.html;

#         # HTML files - no cache
#         location ~* \.html$ {
#             expires -1;
#             add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
#         }
#     }

#     # Deny access to hidden files
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Deny access to sensitive files
#     location ~ ^/(\.env|\.git|node_modules|package\.json|package-lock\.json) {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Logging
#     access_log /var/log/nginx/kidrove-in-access.log;
#     error_log /var/log/nginx/kidrove-in-error.log warn;
# }

# =====================================================================
# KIDROVE.IN - API
# =====================================================================

# HTTP → HTTPS redirect for api.kidrove.in
# server {
#     listen 80;
#     listen [::]:80;
#     server_name api.kidrove.in;

#     # Allow Let's Encrypt validation
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }

#     # Redirect all other traffic to HTTPS
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }

# HTTPS API for api.kidrove.in
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name api.kidrove.in;

#     # SSL certificates
#     ssl_certificate /etc/letsencrypt/live/api.kidrove.in/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.kidrove.in/privkey.pem;
#     ssl_trusted_certificate /etc/letsencrypt/live/api.kidrove.in/chain.pem;

#     # SSL configuration
#     include snippets/ssl-params.conf;

#     # Security headers
#     include snippets/security-headers.conf;

#     # Connection limiting
#     limit_conn kidrove_conn_limit 10;

#     # Client upload limits
#     client_max_body_size 50M;
#     client_body_timeout 120s;
#     client_header_timeout 120s;

#     # Health check endpoint (no rate limiting)
#     location ~ ^/(api/)?health {
#         include snippets/api-proxy.conf;
#         access_log off;
#     }

#     # All API routes (with rate limiting)
#     location / {
#         limit_req zone=kidrove_api_limit burst=20 nodelay;
#         include snippets/api-proxy.conf;
#     }

#     # Deny access to hidden files
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Logging
#     access_log /var/log/nginx/api-kidrove-in-access.log;
#     error_log /var/log/nginx/api-kidrove-in-error.log warn;
# }

# =====================================================================
# KIDROVE.AE - FRONTEND
# =====================================================================

# HTTP → HTTPS redirect for kidrove.ae and www.kidrove.ae
# server {
#     listen 80;
#     listen [::]:80;
#     server_name kidrove.ae www.kidrove.ae;

#     # Allow Let's Encrypt validation
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }

#     # Redirect all other traffic to HTTPS
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }

# HTTPS Frontend for kidrove.ae and www.kidrove.ae
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name kidrove.ae www.kidrove.ae;

#     # SSL certificates
#     ssl_certificate /etc/letsencrypt/live/kidrove.ae/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/kidrove.ae/privkey.pem;
#     ssl_trusted_certificate /etc/letsencrypt/live/kidrove.ae/chain.pem;

#     # SSL configuration
#     include snippets/ssl-params.conf;

#     # Security headers
#     include snippets/security-headers.conf;

#     # Connection limiting
#     limit_conn kidrove_conn_limit 10;

#     # Document root (same as .com and .in)
#     root /var/www/GEMA-Project/frontend/dist;
#     index index.html;

#     # Gzip compression
#     gzip on;
#     gzip_vary on;
#     gzip_min_length 1024;
#     gzip_comp_level 6;
#     gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
#     gzip_disable "msie6";

#     # Client upload limits
#     client_max_body_size 50M;
#     client_body_timeout 120s;
#     client_header_timeout 120s;

#     # Static assets (long-term cache)
#     location /assets/ {
#         limit_req zone=kidrove_general_limit burst=50 nodelay;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         add_header Access-Control-Allow-Origin "*";
#         access_log off;
#     }

#     # Images (30-day cache)
#     location /images/ {
#         limit_req zone=kidrove_general_limit burst=50 nodelay;
#         expires 30d;
#         add_header Cache-Control "public";
#         access_log off;
#     }

#     # Static files (1-year cache)
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }

#     # Service Worker (no cache)
#     location = /sw.js {
#         add_header Cache-Control "no-cache, no-store, must-revalidate";
#         proxy_cache_bypass 1;
#         proxy_no_cache 1;
#     }

#     # Favicon
#     location = /favicon.ico {
#         expires 7d;
#         access_log off;
#         log_not_found off;
#     }

#     # Robots.txt
#     location = /robots.txt {
#         expires 7d;
#         access_log off;
#         log_not_found off;
#     }

#     # React Router SPA fallback (must be last)
#     location / {
#         limit_req zone=kidrove_general_limit burst=50 nodelay;
#         try_files $uri $uri/ /index.html;

#         # HTML files - no cache
#         location ~* \.html$ {
#             expires -1;
#             add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
#         }
#     }

#     # Deny access to hidden files
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Deny access to sensitive files
#     location ~ ^/(\.env|\.git|node_modules|package\.json|package-lock\.json) {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Logging
#     access_log /var/log/nginx/kidrove-ae-access.log;
#     error_log /var/log/nginx/kidrove-ae-error.log warn;
# }

# =====================================================================
# KIDROVE.AE - API
# =====================================================================

# HTTP → HTTPS redirect for api.kidrove.ae
# server {
#     listen 80;
#     listen [::]:80;
#     server_name api.kidrove.ae;

#     # Allow Let's Encrypt validation
#     location /.well-known/acme-challenge/ {
#         root /var/www/certbot;
#     }

#     # Redirect all other traffic to HTTPS
#     location / {
#         return 301 https://$host$request_uri;
#     }
# }

# HTTPS API for api.kidrove.ae
# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name api.kidrove.ae;

#     # SSL certificates
#     ssl_certificate /etc/letsencrypt/live/api.kidrove.ae/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/api.kidrove.ae/privkey.pem;
#     ssl_trusted_certificate /etc/letsencrypt/live/api.kidrove.ae/chain.pem;

#     # SSL configuration
#     include snippets/ssl-params.conf;

#     # Security headers
#     include snippets/security-headers.conf;

#     # Connection limiting
#     limit_conn kidrove_conn_limit 10;

#     # Client upload limits
#     client_max_body_size 50M;
#     client_body_timeout 120s;
#     client_header_timeout 120s;

#     # Health check endpoint (no rate limiting)
#     location ~ ^/(api/)?health {
#         include snippets/api-proxy.conf;
#         access_log off;
#     }

#     # All API routes (with rate limiting)
#     location / {
#         limit_req zone=kidrove_api_limit burst=20 nodelay;
#         include snippets/api-proxy.conf;
#     }

#     # Deny access to hidden files
#     location ~ /\. {
#         deny all;
#         access_log off;
#         log_not_found off;
#     }

#     # Logging
#     access_log /var/log/nginx/api-kidrove-ae-access.log;
#     error_log /var/log/nginx/api-kidrove-ae-error.log warn;
# }
